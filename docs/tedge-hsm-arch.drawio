<mxfile host="app.diagrams.net" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Safari/537.36" version="26.0.16" pages="2">
  <diagram name="Architecture" id="YAwPFHxUQNysemsvbYTJ">
    <mxGraphModel dx="1242" dy="819" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1654" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="G6yHNsuL1Snmdgs_8i90-2" value="Option 3: Device (host)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1320" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-1" value="HSM" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-2" vertex="1">
          <mxGeometry x="10" y="35" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-11" value="cryptoki (PKCS#11)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-2" source="G6yHNsuL1Snmdgs_8i90-4" target="G6yHNsuL1Snmdgs_8i90-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-4" value="tedge cryptoki&lt;div&gt;service&lt;div&gt;(libc)&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-2" vertex="1">
          <mxGeometry x="10" y="110" width="90" height="50" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-5" value="Alpine Linux Container (musl)" style="swimlane;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-2" vertex="1">
          <mxGeometry x="190" y="95" width="270" height="170" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-7" value="unix socket" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;rotation=90;horizontal=0;" parent="G6yHNsuL1Snmdgs_8i90-5" vertex="1">
          <mxGeometry x="-20" y="30" width="40" height="120" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-10" value="rpc: verify" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-5" source="G6yHNsuL1Snmdgs_8i90-9" target="G6yHNsuL1Snmdgs_8i90-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-9" value="tedge&lt;div&gt;(musl)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-5" vertex="1">
          <mxGeometry x="140" y="57.5" width="120" height="65" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-143" value="&lt;div&gt;tedge&lt;/div&gt;client" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-5" vertex="1">
          <mxGeometry x="140" y="73.75" width="40" height="32.5" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-2" source="G6yHNsuL1Snmdgs_8i90-4" target="G6yHNsuL1Snmdgs_8i90-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-12" value="Option 1a: Device (host)" style="swimlane;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="40" y="1320" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-13" value="HSM" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-12" vertex="1">
          <mxGeometry x="10" y="35" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-14" value="cryptoki (PKCS#11)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-12" source="G6yHNsuL1Snmdgs_8i90-15" target="G6yHNsuL1Snmdgs_8i90-13" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-15" value="&lt;div&gt;p11-kit&lt;/div&gt;&lt;div&gt;server&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-12" vertex="1">
          <mxGeometry x="10" y="125" width="90" height="35" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-16" value="Debian Container (glibc)" style="swimlane;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-12" vertex="1">
          <mxGeometry x="150" y="95" width="310" height="170" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-19" value="tedge&lt;div&gt;(glibc)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-16" vertex="1">
          <mxGeometry x="220" y="95" width="80" height="65" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-22" value="pkcs#11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;fontSize=10;" parent="G6yHNsuL1Snmdgs_8i90-16" source="G6yHNsuL1Snmdgs_8i90-19" target="G6yHNsuL1Snmdgs_8i90-21" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1220" y="235" as="sourcePoint" />
            <mxPoint x="1140" y="235" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-21" value="p11 client&lt;div&gt;.so&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-16" vertex="1">
          <mxGeometry x="120" y="72.5" width="60" height="35" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-20" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-12" source="G6yHNsuL1Snmdgs_8i90-15" target="G6yHNsuL1Snmdgs_8i90-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-17" value="unix socket" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;rotation=90;horizontal=0;" parent="G6yHNsuL1Snmdgs_8i90-12" vertex="1">
          <mxGeometry x="140" y="145" width="30" height="80" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-18" value="pkcs#11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-12" source="G6yHNsuL1Snmdgs_8i90-21" target="G6yHNsuL1Snmdgs_8i90-17" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-33" value="Containers" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=29;" parent="1" vertex="1">
          <mxGeometry x="40" y="1210" width="340" height="50" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-34" value="Interfacing with Hardware Security Modules" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=29;" parent="1" vertex="1">
          <mxGeometry x="80" y="100" width="610" height="50" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-36" value="Device (Linux)" style="swimlane;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="80" y="160" width="550" height="430" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-44" value="Hardware Security Modules" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;verticalAlign=top;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="20" y="30" width="410" height="70" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-37" value="Yubikey" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="30" y="65" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-60" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;endArrow=none;startFill=0;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-41" target="G6yHNsuL1Snmdgs_8i90-59" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-41" value="tedge&lt;div&gt;(glibc or musl-dynamic)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="160" y="340" width="130" height="65" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-43" value="SoftHSM" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="130" y="65" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-45" value="TPM 2.0" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="230" y="65" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-65" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=none;startFill=0;endArrow=none;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-47" target="G6yHNsuL1Snmdgs_8i90-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-47" value="Yubikey" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="30" y="140" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-53" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=none;startFill=0;endArrow=none;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-48" target="G6yHNsuL1Snmdgs_8i90-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-48" value="SoftHSM" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="130" y="140" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-52" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=none;startFill=0;endArrow=none;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-49" target="G6yHNsuL1Snmdgs_8i90-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-49" value="TPM 2.0" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="230" y="140" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-50" value="OP-TEE" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="330" y="140" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-61" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;startArrow=none;startFill=0;endArrow=none;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-59" target="G6yHNsuL1Snmdgs_8i90-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-62" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;startArrow=none;startFill=0;endArrow=none;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-59" target="G6yHNsuL1Snmdgs_8i90-48" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-63" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;startArrow=none;startFill=0;endArrow=none;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-59" target="G6yHNsuL1Snmdgs_8i90-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-64" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;startArrow=none;startFill=0;endArrow=none;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-59" target="G6yHNsuL1Snmdgs_8i90-50" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-59" value="PKCS#11 (cryptoki) API" style="line;strokeWidth=4;html=1;perimeter=backbonePerimeter;points=[];outlineConnect=0;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="80" y="280" width="290" height="10" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-46" value="Arm TrustZone" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="330" y="65" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-51" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=none;startFill=0;endArrow=none;" parent="G6yHNsuL1Snmdgs_8i90-36" source="G6yHNsuL1Snmdgs_8i90-50" target="G6yHNsuL1Snmdgs_8i90-46" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-85" value="&lt;b&gt;configuration:&lt;/b&gt;&lt;div&gt;&lt;div&gt;device.cryptoki.module_path=&amp;lt;path&amp;gt;&lt;/div&gt;&lt;div&gt;device.cryptoki.pin=123456&lt;/div&gt;&lt;/div&gt;&lt;div&gt;device.cryptoki.serial=&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="340" y="355" width="180" height="65" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-100" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="10" y="380" width="20" height="20" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-101" value="Shared Object (.so)" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="30" y="375" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-1" value="Legend" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontStyle=1" parent="G6yHNsuL1Snmdgs_8i90-36" vertex="1">
          <mxGeometry x="10" y="350" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-66" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;Build Challenges&lt;/h1&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;* Do we want to also build glibc in addition to musl builds?&lt;/p&gt;&lt;p&gt;&amp;nbsp; &amp;nbsp;* zigbuild can be used to control the glibc version, e.g. 2.17 so it is very compatible, but it can&#39;t be used to build all targets (but the main ones at least)&lt;/p&gt;&lt;p&gt;&amp;nbsp; &amp;nbsp; * do we want to depend on cargo-zigbuild (and ziglang) to build our project?&lt;/p&gt;&lt;p&gt;* Building crypto libraries is very difficult at this point in time (ring is actually better than aws-lc-rs!), and building for both musl and glibc is not a guarantee&lt;br&gt;&lt;br&gt;* yocto builds produce glibc compiled binaries&lt;br&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Some MUSL limitations&lt;/b&gt;&lt;/p&gt;&lt;p&gt;* No support for NSS (Name Service Switch) - Fedora IoT users issue (https://github.com/thin-edge/thin-edge.io/issues/2042)&lt;/p&gt;&lt;p&gt;* Can&#39;t load shared library objects (though maybe this is the last one?)&lt;/p&gt;&lt;p&gt;* less compatible with other tooling, e.g. proxychains-ng (to support proxies without having)&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Useful links&lt;/b&gt;&lt;/p&gt;&lt;p&gt;How other people do it - python wheel packaging - https://github.com/pypa/manylinux&lt;/p&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="940" y="2420" width="360" height="640" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-67" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;Option 3: Custom cryptoki proxy service&lt;br&gt;&lt;/h1&gt;&lt;div&gt;Create client which can act as a proxy between a unix socket (used by tedge) and the cryptoki libraries. It must be compiled with glibc so it can load the shared objects.&lt;br&gt;&lt;br&gt;There is an existing project which provides such a service, called &quot;parsec&quot; (https://parallaxsecond.github.io/parsec-book/) which provides a unix socket, and a custom client library to interact with different HSMs (via PKCS#11 and other providers)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Advantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* No change in build targets (keep with musl)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Disadvantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* Need to worry about security of the unix socket (is just protecting the socket good enough)?&lt;/div&gt;&lt;div&gt;* Socket ownership is still challenging when using non-root users inside the container&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* How to manage the service on the host? (e.g. updating etc.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1640" width="380" height="440" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-68" value="Option 2: Device (host)" style="swimlane;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="640" y="1320" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-69" value="HSM" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-68" vertex="1">
          <mxGeometry x="10" y="35" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-70" value="cryptoki (PKCS#11)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-68" source="G6yHNsuL1Snmdgs_8i90-71" target="G6yHNsuL1Snmdgs_8i90-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-71" value="opensc&lt;div&gt;server&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-68" vertex="1">
          <mxGeometry x="10" y="125" width="90" height="35" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-72" value="Alpine Linux Container (musl)" style="swimlane;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-68" vertex="1">
          <mxGeometry x="150" y="95" width="310" height="170" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-73" value="tedge&lt;div&gt;(musl)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-72" vertex="1">
          <mxGeometry x="230" y="95" width="70" height="65" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-74" value="via&lt;div&gt;cli&lt;/div&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-72" source="G6yHNsuL1Snmdgs_8i90-73" target="G6yHNsuL1Snmdgs_8i90-75" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1220" y="235" as="sourcePoint" />
            <mxPoint x="1140" y="235" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-75" value="opensc&lt;div&gt;client&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-72" vertex="1">
          <mxGeometry x="90" y="72.5" width="60" height="35" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-76" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-68" source="G6yHNsuL1Snmdgs_8i90-71" target="G6yHNsuL1Snmdgs_8i90-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-77" value="unix socket" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;rotation=90;horizontal=0;" parent="G6yHNsuL1Snmdgs_8i90-68" vertex="1">
          <mxGeometry x="140" y="145" width="30" height="80" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-78" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-68" source="G6yHNsuL1Snmdgs_8i90-75" target="G6yHNsuL1Snmdgs_8i90-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-79" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;Option 1a: Use Debian container and compile with glibc&lt;br&gt;&lt;/h1&gt;&lt;div&gt;Use p11-kit server/client which communicates via a unix socket to the host to access the HSMs.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;See&amp;nbsp;https://p11-glue.github.io/p11-glue/p11-kit/manual/remoting.html&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Advantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* No change in build targets (keep with musl)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* No custom software (only to interface with the cryptoki library)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Disadvantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;* Need to change to musl build (though only for the container?)&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* Larger container images (~35MB larger)&lt;/div&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="1640" width="380" height="400" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-80" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;Option 2: Use cli interface to sign tls&lt;br&gt;&lt;/h1&gt;&lt;div&gt;Create client which can act as a proxy between a unix socket (used by tedge) and the cryptoki libraries. It must be compiled with glibc so it can load the shared objects.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Advantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* No change in build targets (keep with musl)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* No permission problems (can easily use sudo to elevate to root)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Disadvantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* Cumbersome to maintain (is the cli commands/args stable?)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* Not easy to extend for future use-cases (e.g. also use it to encrypt/decrypt data)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* Slower than (not sure if this is really a problem)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* Need to worry about security of the unix socket (is just protecting the socket good enough)?&lt;/div&gt;&lt;div&gt;* Socket ownership is still challenging when using non-root users inside the container&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* How to manage the service on the host? (e.g. updating etc.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="640" y="1640" width="380" height="500" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-86" value="Option 1b: Device (host)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="2040" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-87" value="HSM" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-86" vertex="1">
          <mxGeometry x="10" y="35" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-88" value="cryptoki (PKCS#11)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-86" source="G6yHNsuL1Snmdgs_8i90-89" target="G6yHNsuL1Snmdgs_8i90-87" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-89" value="p11-kit&lt;br&gt;&lt;div&gt;server&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-86" vertex="1">
          <mxGeometry x="10" y="125" width="90" height="35" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-90" value="Alpine Linux Container (musl non-static)" style="swimlane;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-86" vertex="1">
          <mxGeometry x="150" y="95" width="310" height="170" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-91" value="tedge&lt;div&gt;(musl*&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;)&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-90" vertex="1">
          <mxGeometry x="220" y="95" width="80" height="65" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-92" value="pkcs#11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;fontSize=10;" parent="G6yHNsuL1Snmdgs_8i90-90" source="G6yHNsuL1Snmdgs_8i90-91" target="G6yHNsuL1Snmdgs_8i90-93" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1220" y="235" as="sourcePoint" />
            <mxPoint x="1140" y="235" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-93" value="p11 client&lt;div&gt;.so&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-90" vertex="1">
          <mxGeometry x="120" y="72.5" width="60" height="35" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-94" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-86" source="G6yHNsuL1Snmdgs_8i90-89" target="G6yHNsuL1Snmdgs_8i90-95" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-95" value="unix socket" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;rotation=90;horizontal=0;" parent="G6yHNsuL1Snmdgs_8i90-86" vertex="1">
          <mxGeometry x="140" y="145" width="30" height="80" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-96" value="pkcs#11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-86" source="G6yHNsuL1Snmdgs_8i90-93" target="G6yHNsuL1Snmdgs_8i90-95" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-98" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;Option 1b: Use Alpine Linux container and build within container&lt;br&gt;&lt;/h1&gt;&lt;div&gt;Use p11-kit server/client which communicates via a unix socket to the host to access the HSMs.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;See&amp;nbsp;https://p11-glue.github.io/p11-glue/p11-kit/manual/remoting.html&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Advantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* No custom software (only to interface with the cryptoki library)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Disadvantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;* Need to change to build tedge inside the alpine container - Compiling under multi-arch docker buildx generally does not work due to the long compile times due to the CPU emulation (build times &amp;gt; 1 hour per arch) and generally OOM errors can stop the build before completion (using &quot;-j 1&quot; does not always avoid OOM errors).&lt;br&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="50" y="2360" width="470" height="400" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-99" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;cargo-zigbuild&lt;/h1&gt;&lt;p&gt;&lt;b&gt;Compatable Targets&lt;/b&gt;&lt;/p&gt;&lt;p&gt;*&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;x86_64-unknown-linux-gnu.2.17&lt;/span&gt;&lt;/p&gt;&lt;p&gt;*&amp;nbsp;i686-unknown-linux-gnu&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;.2.17&lt;/span&gt;&lt;/p&gt;&lt;p&gt;* aarch64-unknown-linux-gnu&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;.2.17&lt;/span&gt;&lt;/p&gt;&lt;p&gt;* armv7-unknown-linux-gnueabihf&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;.2.17&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;* arm-unknown-linux-gnueabihf&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;.2.17&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;* (nice to have)&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent;&quot;&gt;aarch64-apple-darwin&lt;/span&gt;&lt;/p&gt;&lt;p&gt;*&amp;nbsp;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;(nice to have)&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;x86_64-apple-darwin&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Incompatible Targets&lt;br&gt;&lt;br&gt;&lt;/b&gt;&lt;/p&gt;&lt;p&gt;&lt;i&gt;The following targets still need to use clang to build them (the current build method).&lt;/i&gt;&lt;/p&gt;&lt;p&gt;*&amp;nbsp;&lt;span style=&quot;background-color: transparent;&quot;&gt;arm-unknown-linux-musleabi&lt;/span&gt;&lt;/p&gt;&lt;p&gt;* armv5te-unknown-linux-musleabi&lt;/p&gt;&lt;p&gt;*&amp;nbsp;riscv64gc-unknown-linux-gnu&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;b&gt;Targets by Package Type&lt;/b&gt;&lt;/p&gt;&lt;p&gt;deb/rpm (Debian, Fedora) - use glibc&lt;/p&gt;&lt;p&gt;apk (Alpine Linux) - use musl (dynamically linked)&lt;/p&gt;&lt;p&gt;tarball - use musl (static)&lt;/p&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1440" y="2410" width="360" height="630" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-130" value="Option 2b: Device (host)" style="swimlane;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="1000" y="2090" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-131" value="HSM" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-130" vertex="1">
          <mxGeometry x="10" y="35" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-132" value="cryptoki (PKCS#11)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-130" source="G6yHNsuL1Snmdgs_8i90-133" target="G6yHNsuL1Snmdgs_8i90-131" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-133" value="opensc&lt;div&gt;server&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-130" vertex="1">
          <mxGeometry x="10" y="125" width="90" height="35" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-134" value="Alpine Linux Container (musl)" style="swimlane;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-130" vertex="1">
          <mxGeometry x="150" y="95" width="310" height="170" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-135" value="tedge&lt;div&gt;(*musl)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-134" vertex="1">
          <mxGeometry x="230" y="95" width="70" height="65" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-136" value="cryptoki" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-134" source="G6yHNsuL1Snmdgs_8i90-135" target="G6yHNsuL1Snmdgs_8i90-137" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1220" y="235" as="sourcePoint" />
            <mxPoint x="1140" y="235" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-137" value="p11-client&lt;div&gt;.so&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="G6yHNsuL1Snmdgs_8i90-134" vertex="1">
          <mxGeometry x="90" y="72.5" width="60" height="35" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-138" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-130" source="G6yHNsuL1Snmdgs_8i90-133" target="G6yHNsuL1Snmdgs_8i90-139" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-139" value="unix socket" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;rotation=90;horizontal=0;" parent="G6yHNsuL1Snmdgs_8i90-130" vertex="1">
          <mxGeometry x="140" y="145" width="30" height="80" as="geometry" />
        </mxCell>
        <mxCell id="G6yHNsuL1Snmdgs_8i90-140" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="G6yHNsuL1Snmdgs_8i90-130" source="G6yHNsuL1Snmdgs_8i90-137" target="G6yHNsuL1Snmdgs_8i90-139" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-32" value="Option 1b: Device (host)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="730" y="290" width="500" height="280" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-33" value="HSM" style="rounded=0;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-32" vertex="1">
          <mxGeometry x="10" y="35" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-34" value="cryptoki (PKCS#11)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=classic;startFill=1;" parent="7khb8DyhQR_v5AJTT8p7-32" source="7khb8DyhQR_v5AJTT8p7-35" target="7khb8DyhQR_v5AJTT8p7-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-35" value="p11-kit&lt;br&gt;&lt;div&gt;server&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-32" vertex="1">
          <mxGeometry x="10" y="125" width="90" height="35" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-36" value="Alpine Linux Container (musl non-static)" style="swimlane;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-32" vertex="1">
          <mxGeometry x="150" y="95" width="330" height="170" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-37" value="tedge&lt;div&gt;(musl*&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;)&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-36" vertex="1">
          <mxGeometry x="240" y="57.5" width="80" height="65" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-38" value="pkcs#11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;fontSize=10;" parent="7khb8DyhQR_v5AJTT8p7-36" source="7khb8DyhQR_v5AJTT8p7-37" target="7khb8DyhQR_v5AJTT8p7-39" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1220" y="235" as="sourcePoint" />
            <mxPoint x="1140" y="235" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-39" value="p11 client&lt;div&gt;.so&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-36" vertex="1">
          <mxGeometry x="120" y="72.5" width="60" height="35" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-40" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="7khb8DyhQR_v5AJTT8p7-32" source="7khb8DyhQR_v5AJTT8p7-35" target="7khb8DyhQR_v5AJTT8p7-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-41" value="unix socket" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;rotation=90;horizontal=0;" parent="7khb8DyhQR_v5AJTT8p7-32" vertex="1">
          <mxGeometry x="140" y="145" width="30" height="80" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-42" value="pkcs#11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="7khb8DyhQR_v5AJTT8p7-32" source="7khb8DyhQR_v5AJTT8p7-39" target="7khb8DyhQR_v5AJTT8p7-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-43" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;Option 1b: Use Alpine Linux container and build within container&lt;br&gt;&lt;/h1&gt;&lt;div&gt;Use p11-kit server/client which communicates via a unix socket to the host to access the HSMs.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;See&amp;nbsp;https://p11-glue.github.io/p11-glue/p11-kit/manual/remoting.html&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Advantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* No custom software (only to interface with the cryptoki library)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Disadvantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;* Need to change to build tedge inside the alpine container - Compiling under multi-arch docker buildx generally does not work due to the long compile times due to the CPU emulation (build times &amp;gt; 1 hour per arch) and generally OOM errors can stop the build before completion (using &quot;-j 1&quot; does not always avoid OOM errors).&lt;br&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="740" y="610" width="470" height="400" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-44" value="Option 3: Device (host)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1460" y="300" width="480" height="280" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-45" value="HSM" style="rounded=0;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-44" vertex="1">
          <mxGeometry x="10" y="35" width="90" height="30" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-46" value="cryptoki (PKCS#11)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;startArrow=classic;startFill=1;" parent="7khb8DyhQR_v5AJTT8p7-44" source="7khb8DyhQR_v5AJTT8p7-47" target="7khb8DyhQR_v5AJTT8p7-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-47" value="tedge cryptoki&lt;div&gt;service&lt;div&gt;(libc)&lt;/div&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-44" vertex="1">
          <mxGeometry x="10" y="110" width="90" height="50" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-48" value="Alpine Linux Container (musl)" style="swimlane;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-44" vertex="1">
          <mxGeometry x="190" y="95" width="270" height="170" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-49" value="unix socket" style="shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;rotation=90;horizontal=0;" parent="7khb8DyhQR_v5AJTT8p7-48" vertex="1">
          <mxGeometry x="-20" y="30" width="40" height="120" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-50" value="rpc: verify" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="7khb8DyhQR_v5AJTT8p7-48" source="7khb8DyhQR_v5AJTT8p7-51" target="7khb8DyhQR_v5AJTT8p7-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-51" value="tedge&lt;div&gt;(musl)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-48" vertex="1">
          <mxGeometry x="140" y="57.5" width="120" height="65" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-52" value="&lt;div&gt;tedge&lt;/div&gt;client" style="rounded=0;whiteSpace=wrap;html=1;" parent="7khb8DyhQR_v5AJTT8p7-48" vertex="1">
          <mxGeometry x="140" y="73.75" width="40" height="32.5" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-53" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;entryPerimeter=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;startArrow=classic;startFill=1;" parent="7khb8DyhQR_v5AJTT8p7-44" source="7khb8DyhQR_v5AJTT8p7-47" target="7khb8DyhQR_v5AJTT8p7-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-54" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;Option 3: Custom cryptoki proxy service&lt;br&gt;&lt;/h1&gt;&lt;div&gt;Create client which can act as a proxy between a unix socket (used by tedge) and the cryptoki libraries. It must be compiled with glibc so it can load the shared objects.&lt;br&gt;&lt;br&gt;There is an existing project which provides such a service, called &quot;parsec&quot; (https://parallaxsecond.github.io/parsec-book/) which provides a unix socket, and a custom client library to interact with different HSMs (via PKCS#11 and other providers)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Advantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* No change in build targets (keep with musl)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Disadvantages&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* Need to worry about security of the unix socket (is just protecting the socket good enough)?&lt;/div&gt;&lt;div&gt;* Socket ownership is still challenging when using non-root users inside the container&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* How to manage the service on the host? (e.g. updating etc.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="1460" y="620" width="380" height="440" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-55" value="Implementation plan" style="text;html=1;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=29;fillColor=#f5f5f5;strokeColor=#666666;fontColor=#333333;" parent="1" vertex="1">
          <mxGeometry x="730" y="100" width="1240" height="50" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-56" value="Phase 1 - Load .so module directly in tedge" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=29;" parent="1" vertex="1">
          <mxGeometry x="730" y="170" width="610" height="50" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-57" value="Phase 2 - Load .so module in new tedge-cryptoki provider" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=29;" parent="1" vertex="1">
          <mxGeometry x="1460" y="170" width="610" height="80" as="geometry" />
        </mxCell>
        <mxCell id="7khb8DyhQR_v5AJTT8p7-58" value="&lt;h1 style=&quot;margin-top: 0px;&quot;&gt;Notes&lt;/h1&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Phase 3:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;* Support parsec (in addition to the &quot;tedge cryptoki client&quot;)?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;whiteSpace=wrap;overflow=hidden;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2130" y="470" width="380" height="440" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="6Sd4CxLUMhpZO4mJBVmk" name="Packaging">
    <mxGraphModel dx="994" dy="655" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1654" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="Jg9mJooc1mO2tVkDPt10-3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="Jg9mJooc1mO2tVkDPt10-1" target="Jg9mJooc1mO2tVkDPt10-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-1" value="tedge-container-bundle&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;(no PKCS11 support)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="240" y="280" width="150" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="Jg9mJooc1mO2tVkDPt10-2" target="Jg9mJooc1mO2tVkDPt10-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-8" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.75;exitY=0;exitDx=0;exitDy=0;" edge="1" parent="1" source="Jg9mJooc1mO2tVkDPt10-2" target="Jg9mJooc1mO2tVkDPt10-7">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-12" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.75;exitY=0;exitDx=0;exitDy=0;" edge="1" parent="1" source="Jg9mJooc1mO2tVkDPt10-2" target="Jg9mJooc1mO2tVkDPt10-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-2" value="&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;tedge-container-bundle&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;With PKCS11&amp;nbsp;Enabled&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="440" y="400" width="150" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-4" value="&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;tedge-container-bundle&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;With PKCS11 Enabled +&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: transparent; color: light-dark(rgb(0, 0, 0), rgb(255, 255, 255));&quot;&gt;Customer Apps&lt;/span&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="650" y="530" width="150" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.25;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="Jg9mJooc1mO2tVkDPt10-7" target="Jg9mJooc1mO2tVkDPt10-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="xjz0RAIh2suc-QlEAIFw-1" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="Jg9mJooc1mO2tVkDPt10-7" target="Jg9mJooc1mO2tVkDPt10-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-7" value="p11-kit server" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="477" y="170" width="150" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-9" value="HSM&lt;div&gt;(PKCS11 Interface to HSM)&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="514" y="10" width="150" height="80" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-13" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;entryX=0.75;entryY=1;entryDx=0;entryDy=0;" edge="1" parent="1" source="Jg9mJooc1mO2tVkDPt10-11" target="Jg9mJooc1mO2tVkDPt10-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="Jg9mJooc1mO2tVkDPt10-11" value="tedge-cryptoki&lt;div&gt;service&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fillStyle=hatch;" vertex="1" parent="1">
          <mxGeometry x="650" y="170" width="150" height="80" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
